=====================
Local force constants
=====================

Local force constants can be calculated with the local modes method [1]_ or
the compliance matrix method [2]_. Steriplus can use the output of Gaussian_,
xtb_, or UniMoVib_ programs.

===============
Preparing input
===============

The LocalForce class needs input from quantum-chemical frequency calculations.
Therefore, the instructions are a bit more involved. This input can either be
read using the ``load_file`` method, and Steriplus can also provide by 
built-in normal mode analysis and internal coordinate codes.

***********
Local modes
***********

The local modes approach needs the normal modes in terms of internal
coordinates, here called *internal modes*, as well as the normal mode force
constants. These can either be read from a file or calculated with Steriplus.
For example, the internal modes can be computed from the normal modes and the
Wilson B matrix. For local frequencies, additional input is needed.

.. figure:: images/local_force/diagram_local.svg
  
  Input needed for the local modes approach.

*****************
Compliance matrix
*****************

The compliance matrix method needs the Hessian matrix and the Wilson B matrix.
For local frequencies, the elements are needed (to get the atomic masses).

.. figure:: images/local_force/diagram_compliance.svg
  
  Input needed for the compliance matrix method.


********
Gaussian
********

Gaussian can provide the input for both the local modes and the compliance
matrix methods directly. For the local modes method, it is recommended to
use the log file, while for the the compliance matrix method, the fchk file
is neeed.

==== =========================================
log  ``freq=intmodes iop(7/75=1) iop(1/33=3)``
fchk ``freq=intmodes``
==== =========================================

``iop(7/75=1)`` makes Gaussian print the internal modes with full accuracy,
while ``iop(1/33=3)`` triggers printing of the Wilson B matrix. The table
below lists all the quantities read by each approach.

.. table:: Quantities from Gaussian files.
  :widths: auto
  :align: center

  ==================== === ===
  Quantity             log fck
  ==================== === ===
  Elements              x   x
  Coordinates           x   x
  Internal modes        x   
  Internal coordinates  x   x
  B Matrix              x   
  Normal modes              x
  Hessian                   x
  Force constants       x   x
  ==================== === ===

.. note::
  
  Additional accuracy for local modes calculations be achieved by loading
  also the fchk file which contains the normal mode force constants to
  higher accuracy.

********
UniMoVib
********

The UniMoVib program can do vibrational analysis for a range of different
quantum-chemical programs. The user needs to define internal coordinates in
addition to the information that can be read from the files.

.. csv-table:: UniMoVib
  :file: tables/local_force_unimovib.csv 
  :header-rows: 1
  :stub-columns: 1

The *log* file is the standard output of the program. The *umw* file and the
*local* file can be generated by specifying them in the input file

.. code-block::
  :emphasize-lines: 5, 6
  :caption: Example UniMoVib input file

  a test job

  $contrl
    qcprog="gaussian"
    iflocal=.t.
    ifsave=.t.
  $end

  $qcdata
    fchk="freq.fchk"
  $end

***
xtb
***

The xtb program can provide the Hessian.

.. csv-table:: xtb
  :file: tables/local_force_xtb.csv 
  :header-rows: 1
  :stub-columns: 1

*******************
Command line script
*******************

The command line script provides access to the basic functionality through the 
terminal.

.. code-block:: console
  :caption: Example of single internal coordinate
  
  $ steriplus_local_force freq-hp.log -a 1 2
  5.364

.. code-block:: console
  :caption: Example of report
  
  $ steriplus_local_force freq-hp.log
    Atom_1    Atom_2    Atom_3    Atom_4                           Force constant(mDyne/Å)                       Frequency (cm^-1)
         1         2                                                                 5.364                                    3252
         1         3                                                                 5.364                                    3252
         1         4                                                                 5.364                                    3252
         1         5                                                                 5.364                                    3252

-a <list>
  List of atoms in the bond/internal coordinate.
--cutoff <float>
  Cutoff value for low-frequency modes (default:0.001)
--fchk_file <str>
  Name of Gaussian fchk file
--method <str>
  Method: "local" (default) or "compliance"
--no_project_imaginary
  Flag to disable projection of imaginary modes
--pes_file <str>
  Name of Gaussian PES file
  
More information is given with ``steriplus_local_force --help``

******
Module
******

The LocalForce class is provided to calculate and store the local force
constants.

.. code-block:: python
  :caption: Example with local modes method

  >>> from steriplus import LocalForce
  >>> lf = LocalForce("freq-lm.log")
  >>> fc = lf.get_local_force_constant([1, 2])
  >>> print(fc)
  5.364289643211871

.. code-block:: python
  :caption: Example with compliance matrix method

  >>> from steriplus import LocalForce
  >>> lf = LocalForce("freq-lm.log", fchk_file="freq.fchk", method="compliance")
  >>> fc = lf.get_local_force_constant([1, 2])
  >>> print(fc)
  5.364476039405804

For the local modes method, projection of imaginary frequencies can be
controlled with the ``project_imag=<bool>``. The cutoff for low-freqency modes
can be controlled with ``cutoff=<float>``. Choice of method is controlled with
``method=<str>`` using either ``local`` (default) or ``compliance``. File names
of any fchk file and PES are specified with the ``fchk_file=<str>`` and
``pes_file=<str>`` keywords.

For more detailed information, use ``help(LocalForce)`` or see the API:
:py:class:`steriplus.steriplus.LocalForce`

**********
Background
**********

Local force constants describe the bond strength based on vibrational
frequencies. In the literature, there are two approaches to this, the local
modes method of Cremer [1]_ and the compliance matrix method championed by
Grunenberg [2]_. They have been shown to be equivalent within numerical accuracy
[3]_. Steriplus can use either method, and they give almost identical results
for most bonds. The exception is when imaginary or very small vibrational
frequencies exist. In this case, the numerical stability of the local modes
approach can be improved by two methods: (1) projecting out normal modes with
imaginary frequencies and (2) raising the force constants of the low-frequency
modes to a cutoff value. Steriplus does this projection by default and uses a 
cutoff of 0.001 mDyne/Å for low-frequency modes. We therefore recommend local
modes with default settings as the most robust method. Expert users can turn off this
projection and alter the cutoff value.

Note that interactions involving imaginary modes (such as breaking/forming
bonds in transition states) cannot be assessed by the local force constants.

The results have been benchmarked against the local force constants and
frequencies for small organic molecules given by Cremer [3]_. 

.. figure:: benchmarks/local_force/organic_intmodes.png
  
  Benchmark of local force constants and frequencies against data from Table 1
  of ref. [3]_. Data obtained using the local modes method with recipe 1.

.. figure:: benchmarks/local_force/organic_hpmodes.png
  
  Benchmark of local force constants and frequencies against data from Table 1
  of ref. [3]_. Data obtained using the local modes method with recipe 2.

.. figure:: benchmarks/local_force/organic_fchk.png
  
  Benchmark of local force constants and frequencies against data from Table 1
  of ref. [3]_. Data obtained using the local modes method with recipe 3.

.. figure:: benchmarks/local_force/organic_compliance.png
  
  Benchmark of local force constants and frequencies against data from Table 1
  of ref. [3]_. Data obtained using the compliance matrix method with recipe 2.

**********
References
**********

.. [1] Konkoli, Z.; Cremer, D. Int. J. Quantum Chem. 1998, 67, 1.
.. [2] Brandhorst, K.; Grunenberg, J. Chem. Soc. Rev. 2008, 37, 1558.
.. [3] Zou, W.; Kalescky, R.; Kraka, E.; Cremer, D. J. Chem. Phys. 2012, 137, 84114.

.. _Gaussian: https://gaussian.com/
.. _UniMoVib: https://github.com/zorkzou/UniMoVib
.. _xtb: https://xtb-docs.readthedocs.io/en/latest/contents.html
